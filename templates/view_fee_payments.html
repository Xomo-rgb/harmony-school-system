{% if session.role == 'accounts' %}
    {% extends "accounts_base.html" %}
{% elif session.role == 'school_admin' %}
    {% extends "school_admin_base.html" %}
{% else %}
    {% extends "admin_base.html" %}
{% endif %}

{% block title %}View Fee Payments{% endblock %}
{% block header_title %}Fee Payment Records{% endblock %}

{% block content %}
<!-- Filter Controls -->
<div class="bg-white p-4 rounded-lg shadow mb-6">
    <form id="filterForm" class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
        <div>
            <label for="academic_year_filter" class="block text-sm font-medium text-gray-700">Academic Year</label>
            <select id="academic_year_filter" name="academic_year" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                <option value="">All Years</option>
                {% for year in academic_years %}<option value="{{ year }}">{{ year }}</option>{% endfor %}
            </select>
        </div>
        <div>
            <label for="term_filter" class="block text-sm font-medium text-gray-700">Term</label>
            <select id="term_filter" name="term" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                <option value="">All Terms</option>
                {% for t in terms %}<option value="{{ t }}">{{ t }}</option>{% endfor %}
            </select>
        </div>
        <div>
            <label for="class_filter" class="block text-sm font-medium text-gray-700">Class</label>
            <select id="class_filter" name="class_name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                <option value="">All Classes</option>
                {% for c in classes %}<option value="{{ c }}">{{ c|title }}</option>{% endfor %}
            </select>
        </div>
        <div></div>
        <button type="button" id="reset_filters" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 text-sm">Reset Filters</button>
    </form>
</div>
<!-- Payments Table -->
<div class="overflow-x-auto bg-white rounded-lg shadow">
    <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
            <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Student Name</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Class</th>
                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Amount Paid (MWK)</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Payment Date</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Term</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Year</th>
                {% if session.role == 'accounts' %}<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>{% endif %}
            </tr>
        </thead>
        <tbody id="payments_tbody" class="bg-white divide-y divide-gray-200"></tbody>
    </table>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const filterForm = document.getElementById('filterForm');
    const paymentsTbody = document.getElementById('payments_tbody');
    const userRole = "{{ session.role }}";
    function fetchPayments() {
        paymentsTbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500">Loading...</td></tr>';
        const formData = new FormData(filterForm);
        fetch("{{ url_for('admin.filter_fee_payments') }}", { method: 'POST', body: formData })
        .then(response => response.json())
        .then(data => {
            paymentsTbody.innerHTML = '';
            if (data.payments && data.payments.length > 0) {
                data.payments.forEach(p => {
                    let actionsHtml = '';
                    if (userRole === 'accounts') {
                        actionsHtml = `<td class="px-6 py-4 whitespace-nowrap"><div class="flex space-x-2"><a href="/admin/edit_fee/${p.payment_id}" class="text-emerald-600 hover:text-emerald-800 text-sm">Edit</a><form action="/admin/delete_fee/${p.payment_id}" method="POST" onsubmit="return confirm('Delete this record?');"><button type="submit" class="text-red-600 hover:text-red-800 text-sm">Delete</button></form></div></td>`;
                    }
                    const tr = document.createElement('tr');
                    let tableRowHtml = `<td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${p.full_name}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${p.class_name}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800 text-right">${parseFloat(p.amount_paid).toFixed(2)}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${p.payment_date}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${p.term}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${p.academic_year}</td>`;
                    if(userRole === 'accounts') { tableRowHtml += actionsHtml; }
                    tr.innerHTML = tableRowHtml;
                    paymentsTbody.appendChild(tr);
                });
            } else {
                const colSpan = userRole === 'accounts' ? 7 : 6;
                paymentsTbody.innerHTML = `<tr><td colspan="${colSpan}" class="text-center py-4 text-gray-500">No payment records found.</td></tr>`;
            }
        });
    }
    document.querySelectorAll('#filterForm input, #filterForm select').forEach(input => {
        input.addEventListener('change', fetchPayments);
    });
    document.getElementById('reset_filters').addEventListener('click', () => {
        filterForm.reset();
        fetchPayments();
    });
    fetchPayments();
});
</script>
{% endblock %}