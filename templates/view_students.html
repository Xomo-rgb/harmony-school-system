{% if session.role == 'teacher' %}
    {% extends "teacher_base.html" %}
{% elif session.role == 'accounts' %}
    {% extends "accounts_base.html" %}
{% elif session.role == 'school_admin' %}
    {% extends "school_admin_base.html" %}
{% else %}
    {% extends "admin_base.html" %}
{% endif %}

{% block title %}Student Roster{% endblock %}
{% block header_title %}Student Roster{% endblock %}

{% block content %}
<div class="mb-6 flex flex-col md:flex-row md:items-center md:justify-between">
    <div></div>
    <div class="flex items-center space-x-4">
        <form id="filterForm" class="flex items-center space-x-2">
            <label for="class_name" class="font-medium text-gray-700 text-sm">Filter by Class:</label>
            <select name="class_name" id="class_name" class="form-select rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500">
                <option value="">All Classes</option>
                <option value="nursery">Nursery</option><option value="reception">Reception</option><option value="standard 1">Standard 1</option><option value="standard 2">Standard 2</option><option value="standard 3">Standard 3</option><option value="standard 4">Standard 4</option><option value="standard 5">Standard 5</option><option value="standard 6">Standard 6</option>
            </select>
        </form>
        {% if session['role'] in ['school_admin', 'system_admin'] %}
        <a href="{{ url_for('student.register_student') }}" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 text-sm font-medium">+ Register New Student</a>
        {% endif %}
    </div>
</div>
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}<div class="mb-4 space-y-2">{% for c, m in messages %}<div class="p-3 rounded-md text-sm {%if c=='error'%}bg-red-100 text-red-800{%endif%}{%if c=='success'%}bg-green-100 text-green-800{%endif%}">{{m}}</div>{% endfor %}</div>{% endif %}
{% endwith %}
<div class="overflow-x-auto bg-white rounded-lg shadow">
    <table class="min-w-full divide-y divide-gray-200" id="studentsTable">
        <thead class="bg-gray-50">
            <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Student Number</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Full Name</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Class</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Guardian's Phone</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
            </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
            {% for student in students %}
            <tr>
                <td class="px-6 py-4 text-sm text-gray-900">{{ student.student_number }}</td>
                <td class="px-6 py-4 text-sm font-medium text-gray-900">
                    <!-- *** THE LINK IS HERE *** -->
                    <a href="{{ url_for('student.profile', student_id=student.student_id) }}" class="text-indigo-600 hover:underline">
                        {{ student.first_name }} {{ student.middle_name or '' }} {{ student.last_name }}
                    </a>
                </td>
                <td class="px-6 py-4 text-sm text-gray-500">{{ student.class_name|title }}</td>
                <td class="px-6 py-4 text-sm text-gray-500">{{ student.guardian_contact }}</td>
                <td class="px-6 py-4 text-sm font-medium">
                    {% if session['role'] in ['school_admin', 'system_admin'] %}
                        <div class="flex space-x-4">
                            <a href="{{ url_for('student.edit_student', student_id=student.student_id) }}" class="text-green-600 hover:text-green-900">Edit</a>
                            <form action="{{ url_for('student.delete_student', student_id=student.student_id) }}" method="post" onsubmit="return confirm('Delete this student?');"><button type="submit" class="text-red-600 hover:text-red-900">Delete</button></form>
                        </div>
                    {% else %}
                        <span class="text-gray-400">View Only</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <div id="loadingState" class="hidden p-6 text-center text-gray-500">Loading...</div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const classSelect = document.getElementById('class_name');
    const tableBody = document.querySelector('#studentsTable tbody');
    const loadingState = document.getElementById('loadingState');
    const userRole = "{{ session['role'] }}";
    classSelect.addEventListener('change', () => {
        tableBody.innerHTML = '';
        loadingState.classList.remove('hidden');
        const formData = new FormData();
        formData.append('class_name', classSelect.value);
        fetch('{{ url_for("student.filter_students") }}', {method: 'POST', body: formData})
        .then(response => response.json())
        .then(data => {
            loadingState.classList.add('hidden');
            if (data.students && data.students.length > 0) {
                data.students.forEach(s => {
                    let actionsHtml = '<span class="text-gray-400">View Only</span>';
                    if (userRole === 'school_admin' || userRole === 'system_admin') {
                        actionsHtml = `<div class="flex space-x-4"><a href="/students/edit/${s.student_id}" class="text-green-600 hover:text-green-900">Edit</a><form action="/students/delete/${s.student_id}" method="post" onsubmit="return confirm('Delete?');"><button type="submit" class="text-red-600 hover:text-red-900">Delete</button></form></div>`;
                    }
                    const className = s.class_name.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
                    // *** THE LINK IS HERE (for filtered results) ***
                    tableBody.innerHTML += `<tr><td class="px-6 py-4 text-sm text-gray-900">${s.student_number}</td><td class="px-6 py-4 text-sm font-medium text-gray-900"><a href="/students/profile/${s.student_id}" class="text-indigo-600 hover:underline">${s.full_name}</a></td><td class="px-6 py-4 text-sm text-gray-500">${className}</td><td class="px-6 py-4 text-sm text-gray-500">${s.guardian_contact}</td><td class="px-6 py-4 text-sm font-medium">${actionsHtml}</td></tr>`;
                });
            } else {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">No students found.</td></tr>';
            }
        })
        .catch(error => {
            loadingState.classList.add('hidden');
            tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-red-500">Error loading data.</td></tr>';
            console.error('Error:', error);
        });
    });
});
</script>
{% endblock %}